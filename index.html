<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Генератор ANSI‑блоков для Discord</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; background: #f3f4f6; }
    #editor { width:100%; max-width:800px; min-height:200px; margin:2rem auto; padding:1rem; background:#fff; border:1px solid #ddd; border-radius:.5rem; white-space: pre-wrap; }
    .toolbar { position:fixed; top:1rem; right:1rem; width:240px; background:#fff; padding:1rem; border:1px solid #ddd; border-radius:.5rem; }
    .toolbar button { width:100%; margin-bottom:.5rem; padding:.5rem; border:1px solid #ccc; border-radius:.25rem; cursor:pointer; background:#fafafa; }
    .toolbar .palette { display:grid; grid-template-columns:repeat(4,1fr); gap:.25rem; margin-bottom:.5rem; }
    .palette button { width:100%; height:1.5rem; border:1px solid #ccc; padding:0; }
    #bold { font-weight:bold; }
    #underline { text-decoration:underline; }
    #toast { position:fixed; bottom:1rem; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:.5rem 1rem; border-radius:.5rem; opacity:0; transition:opacity .3s; }
    #toast.show { opacity:1; }
  </style>
</head>
<body>
  <h1 style="text-align:center; margin-top:1rem;">Генератор ANSI‑блоков для Discord</h1>
  <div id="editor" contenteditable></div>
  <div class="toolbar">
    <button id="copy">Скопировать в Discord</button>
    <button id="clear">Очистить форматирование</button>
    <div id="bg-preview" class="palette" style="margin-top:1rem;"></div>
    <div style="font-weight:bold; margin-top:1rem;">Цвет текста</div>
    <div id="fg-palette" class="palette"></div>
    <div style="font-weight:bold;">Цвет фона</div>
    <div id="bg-palette" class="palette"></div>
    <div style="font-weight:bold; margin-top:.5rem;">Стили</div>
    <button id="bold">B</button>
    <button id="underline">U</button>
  </div>
  <div id="toast">Скопировано!</div>
<script>
  const ESC='\u001b';
  // Точные CSS цвета фоновых кодов Discord ANSI
  const bgCss = [
    '#191919', // Firefly dark blue background (approx)
    '#fc9533', // Orange background
    '#2f74b5', // Marble blue background
    '#5bc7a3', // Greyish turquoise
    '#5c5c5c', // Gray background
    '#5246a6', // Indigo background
    '#d1d1d1', // Light gray background
    '#ffffff'  // White background
  ];
  const fgCss = ['#7f8c8d','#e74c3c','#2ecc71','#f1c40f','#3498db','#9b59b6','#1abc9c','#ecf0f1'];
  const fgCodes=[30,31,32,33,34,35,36,37];
  const bgCodes=fgCodes.map(c=>c+10);

  function wrap(type,value){
    const sel=window.getSelection(); if(!sel.rangeCount) return;
    const range=sel.getRangeAt(0);
    const span=document.createElement('span');
    span.dataset[type]=value;
    if(type==='fg') span.style.color=fgCss[fgCodes.indexOf(value)];
    if(type==='bg') span.style.backgroundColor=bgCss[bgCodes.indexOf(value)];
    if(type==='bold') span.style.fontWeight='bold';
    if(type==='underline') span.style.textDecoration='underline';
    span.appendChild(range.extractContents());
    range.insertNode(span);
    sel.removeAllRanges();
  }
  const fgCont=document.getElementById('fg-palette'), bgCont=document.getElementById('bg-palette');
  fgCodes.forEach((c,i)=>{ const b=document.createElement('button');b.style.background=fgCss[i];b.onclick=()=>wrap('fg',c);fgCont.appendChild(b);});
  bgCodes.forEach((c,i)=>{ const b=document.createElement('button');b.style.background=bgCss[i];b.onclick=()=>wrap('bg',c);bgCont.appendChild(b);});
  document.getElementById('bold').onclick=()=>wrap('bold',1);
  document.getElementById('underline').onclick=()=>wrap('underline',4);
  document.getElementById('clear').onclick=()=>{ const ed=document.getElementById('editor'); ed.innerText=ed.innerText; };

  function generateANSI(root){
    let out='';
    const paras=[]; let cur=[];
    root.childNodes.forEach(n=>{ if(n.nodeType===1&&n.tagName==='BR'){paras.push(cur);cur=[];}else cur.push(n);} );
    paras.push(cur);
    paras.forEach(nodes=>{
      const chars=[];
      function rec(node,fmt){
        const f=Object.assign({},fmt);
        if(node.nodeType===1&&node.tagName==='SPAN'){
          if(node.dataset.bold) f.bold=true;
          if(node.dataset.underline) f.underline=true;
          if(node.dataset.fg) f.fg=node.dataset.fg;
          if(node.dataset.bg) f.bg=node.dataset.bg;
        }
        if(node.nodeType===3){
          node.textContent.split('').forEach(ch=>chars.push({ch,fmt:f}));
        } else if(node.nodeType===1){
          if(node.tagName==='BR') chars.push({ch:'\n',fmt:{}});
          else Array.from(node.childNodes).forEach(c=>rec(c,f));
        }
      }
      nodes.forEach(n=>rec(n,{}));
      const hasColor=chars.some(i=>i.fmt.fg||i.fmt.bg);
      if(hasColor){
        out+='```ansi\n';
        let prev={bold:false,underline:false,fg:null,bg:null};
        chars.forEach(item=>{
          const f=item.fmt;
          if(item.ch!==' '&&item.ch!=='\n'&&(
            f.bold!==prev.bold||f.underline!==prev.underline||f.fg!==prev.fg||f.bg!==prev.bg
          )){
            const codes=[ f.bold?1:0, f.underline?4:0, f.fg||0, f.bg||0 ];
            out+=ESC+'['+codes.join(';')+'m';
            prev=f;
          }
          out+=item.ch;
        });
        out+=ESC+'[0;0;0;0m\n```\n';
      } else {
        let line='';
        chars.forEach(item=>{
          if(item.fmt.bold&&item.ch.trim()) line+='**'+item.ch+'**';
          else line+=item.ch;
        });
        out+=line+'\n';
      }
    });
    return out;
  }
  document.getElementById('copy').onclick=()=>{
    const txt=generateANSI(document.getElementById('editor'));
    navigator.clipboard.writeText(txt).then(()=>{const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500);});
  };
</script>
</body>
</html>
