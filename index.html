<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Генератор ANSI‑блоков для Discord</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #1f2030;
      color: #dcddde;
    }
    #editor {
      width:100%;
      max-width:800px;
      min-height:200px;
      margin:2rem auto;
      padding:1rem;
      background:#2f3136;
      color:#dcddde;
      border:1px solid #36393f;
      border-radius:.5rem;
      white-space: pre-wrap;
      outline:none;
    }
    .toolbar {
      position:fixed;
      top:1rem; right:1rem;
      width:260px;
      background:#2f3136;
      color:#dcddde;
      padding:1rem;
      border:1px solid #36393f;
      border-radius:.5rem;
    }
    .toolbar button {
      width:100%;
      margin-bottom:.5rem;
      padding:.5rem;
      cursor:pointer;
      background:#36393f;
      color:#dcddde;
      border:1px solid #202225;
      border-radius:.25rem;
    }
    .toolbar .palette { display:grid; gap:.25rem; }
    #fg-palette { grid-template-columns: repeat(4,1fr); }
    #bg-palette { grid-template-columns: repeat(8,1fr); }
    .palette button {
      width:100%; height:1.5rem;
      border:1px solid #36393f;
      padding:0;
    }
    #toast {
      position:fixed; bottom:1rem; left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8); color:#fff;
      padding:.5rem 1rem; border-radius:.5rem;
      opacity:0; transition:opacity .3s;
    }
    #toast.show { opacity:1; }
  </style>
</head>
<body>
  <h1 style="text-align:center; margin-top:1rem;">Генератор ANSI‑блоков для Discord</h1>
  <div id="editor" contenteditable spellcheck="false"></div>
  <div class="toolbar">
    <button id="copy">Скопировать в Discord</button>
    <button id="clear">Очистить форматирование</button>

    <div style="font-weight:bold; margin-top:1rem;">Цвет текста</div>
    <div id="fg-palette" class="palette"></div>

    <div style="font-weight:bold; margin-top:1rem;">Цвет фона</div>
    <div id="bg-palette" class="palette"></div>

    <div style="font-weight:bold; margin-top:.5rem;">Стили</div>
    <button id="bold">B</button>
    <button id="underline">U</button>
  </div>
  <div id="toast">Скопировано!</div>

  <script>
    const ESC      = '\u001b';
    const NEW_LINE = '\n';

    // палитры
    const fgCss   = ['#586e75','#dc322f','#859900','#b58900','#268bd2','#d33682','#2aa198','#eee8d5'];
    const bgCss   = ['#002b36','#cb4b16','#586e75','#657b83','#839496','#6c71c4','#93a1a1','#fdf6e3'];
    const fgCodes = [30,31,32,33,34,35,36,37];
    const bgCodes = fgCodes.map(c=>c+10);

    function wrap(type, value) {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      const span  = document.createElement('span');
      span.dataset[type] = value;
      if (type==='fg')        span.style.color           = fgCss[ fgCodes.indexOf(+value) ];
      if (type==='bg')        span.style.backgroundColor = bgCss[ bgCodes.indexOf(+value) ];
      if (type==='bold')      span.style.fontWeight      = 'bold';
      if (type==='underline') span.style.textDecoration = 'underline';
      span.appendChild(range.extractContents());
      range.insertNode(span);
      sel.removeAllRanges();
    }

    // рисуем палитры
    const fgCont = document.getElementById('fg-palette');
    const bgCont = document.getElementById('bg-palette');
    fgCodes.forEach((c,i)=>{
      const btn = document.createElement('button');
      btn.style.background = fgCss[i];
      btn.addEventListener('click', e => { e.preventDefault(); wrap('fg', c); });
      fgCont.appendChild(btn);
    });
    bgCodes.forEach((c,i)=>{
      const btn = document.createElement('button');
      btn.style.background = bgCss[i];
      btn.addEventListener('click', e => { e.preventDefault(); wrap('bg', c); });
      bgCont.appendChild(btn);
    });

    // B / U
    ['bold','underline'].forEach(type=>{
      const btn = document.getElementById(type);
      btn.addEventListener('mousedown', e => e.preventDefault());
      btn.addEventListener('click', e => {
        e.preventDefault();
        wrap(type, type==='bold'?1:4);
      });
    });

    // —— очистка по старому алгоритму ——
    const clearBtn = document.getElementById('clear');
    clearBtn.addEventListener('mousedown', e => e.preventDefault());
    clearBtn.addEventListener('click', e => {
      e.preventDefault();
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      const frag  = range.extractContents();
      const clean = document.createDocumentFragment();
      function cleanNode(node) {
        if (node.nodeType===1 && node.tagName==='SPAN') {
          Array.from(node.childNodes).forEach(cleanNode);
        } else {
          clean.appendChild(node.cloneNode(true));
        }
      }
      Array.from(frag.childNodes).forEach(cleanNode);
      range.insertNode(clean);
      document.getElementById('editor').normalize();
      sel.removeAllRanges();
    });

    // —— генерация ANSI с правильными \n ——
    function generateANSI(root) {
      const chars = [];
      function rec(node, fmt) {
        const f = Object.assign({}, fmt);
        if (node.nodeType===1 && node.tagName==='SPAN') {
          if (node.dataset.bold)      f.bold      = 1;
          if (node.dataset.underline) f.underline = 4;
          if (node.dataset.fg)        f.fg        = +node.dataset.fg;
          if (node.dataset.bg)        f.bg        = +node.dataset.bg;
        }
        if (node.nodeType===3) {
          node.textContent.split('').forEach(ch=>{
            chars.push({ ch, fmt: Object.assign({}, f) });
          });
        } else if (node.nodeType===1) {
          if (node.tagName==='BR') {
            chars.push({ ch: NEW_LINE, fmt: Object.assign({}, f) });
          } else if (node.tagName==='DIV') {
            // обработать вложенное содержимое
            Array.from(node.childNodes).forEach(c=>rec(c, f));
            // и добавить перевод строки
            chars.push({ ch: NEW_LINE, fmt: Object.assign({}, f) });
          } else {
            Array.from(node.childNodes).forEach(c=>rec(c, f));
          }
        }
      }
      // запускаем по всем дочерним узлам, чтобы DIV-ы давали \n
      Array.from(root.childNodes).forEach(n=>rec(n, { bold:0, underline:0, fg:0, bg:0 }));

      let out  = '';
      let prev = { bold:0, underline:0, fg:0, bg:0 };
      let any  = false;

      chars.forEach(item => {
        const f = item.fmt;
        if (f.bold||f.underline||f.fg||f.bg) any = true;
        if (
          f.bold      !== prev.bold    ||
          f.underline !== prev.underline||
          f.fg        !== prev.fg      ||
          f.bg        !== prev.bg
        ) {
          const codes = [];
          if (f.bold)      codes.push(1);
          if (f.underline) codes.push(4);
          codes.push(f.fg   || 0);
          // фон 0 → 49
          codes.push(f.bg? f.bg: 49);
          out += ESC + '[' + codes.join(';') + 'm';
          prev = Object.assign({}, f);
        }
        out += item.ch;
      });

      // сброс в конце
      out += ESC + '[0m';

      if (any) {
        return '```ansi' + NEW_LINE
             + out   + NEW_LINE
             + '```';
      } else {
        return out;
      }
    }

    // копирование
    const btnCopy = document.getElementById('copy');
    btnCopy.addEventListener('mousedown', e=>e.preventDefault());
    btnCopy.addEventListener('click', e=>{
      e.preventDefault();
      const txt = generateANSI(document.getElementById('editor'));
      navigator.clipboard.writeText(txt).then(()=>{
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'),1500);
      });
    });
  </script>
</body>
</html>
