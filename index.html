<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Генератор ANSI‑блоков для Discord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #editor span { font-style: italic; }
    /* Стиль кнопок эффектов */
    #bold { font-weight: bold; }
    #italic { font-style: italic; }
    #underline { text-decoration: underline; }
    /* Toast */
    .toast { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: .5rem 1rem; border-radius: .5rem; opacity: 0; transition: opacity .3s; pointer-events: none; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4 text-center">Генератор ANSI‑блоков для Discord</h1>
  <div class="max-w-6xl mx-auto">
    <div id="editor" contenteditable="true" class="border border-gray-300 rounded-lg p-4 bg-white min-h-[500px] whitespace-pre-wrap"></div>
  </div>

  <div class="fixed top-24 right-4 w-60 bg-white p-4 rounded-lg shadow-lg">
    <button id="copy" class="w-full bg-green-600 text-white py-2 rounded-lg mb-2">Скопировать в Discord</button>
    <button id="clear-format" class="w-full bg-red-500 text-white py-2 rounded-lg mb-4">Очистить форматирование</button>
    <div class="mb-2 font-semibold">Цвета</div>
    <div id="palette" class="grid grid-cols-4 gap-1 mb-4"></div>
    <div class="mb-2 font-semibold">Стили</div>
    <div class="flex gap-2">
      <button id="bold" title="Жирный" class="flex-1 border border-gray-400 rounded-lg py-1">B</button>
      <button id="italic" title="Курсив" class="flex-1 border border-gray-400 rounded-lg py-1">I</button>
      <button id="underline" title="Подчёркнутый" class="flex-1 border border-gray-400 rounded-lg py-1">U</button>
    </div>
  </div>

  <div id="toast" class="toast">Скопировано!</div>

<script>
  const ESC = '\u001b';
  const paletteData = [
    {code:'0;30',css:'gray'},{code:'0;31',css:'red'},{code:'0;32',css:'green'},{code:'0;33',css:'yellow'},
    {code:'0;34',css:'blue'},{code:'0;35',css:'magenta'},{code:'0;36',css:'cyan'},{code:'0;37',css:'white'},
    {code:'0;40',css:'darkblue'},{code:'0;41',css:'orange'},{code:'0;42',css:'skyblue'},{code:'0;43',css:'turquoise'},
    {code:'0;44',css:'gray'},{code:'0;45',css:'indigo'},{code:'0;46',css:'lightgray'},{code:'0;47',css:'white'}
  ];

  // Заполняем палитру
  const palette = document.getElementById('palette');
  paletteData.forEach(item => {
    const btn = document.createElement('button');
    btn.className = 'w-8 h-8 rounded-lg border border-gray-300';
    btn.style.backgroundColor = item.css;
    btn.title = '[' + item.code + 'm';
    btn.dataset.ansi = ESC + '[' + item.code + 'm';
    btn.addEventListener('click', () => wrapSelection(item.css, btn.dataset.ansi, 'color'));
    palette.appendChild(btn);
  });

  // Универсальная обёртка выделения
  function wrapSelection(cssValue, ansiCode, mode) {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const frag = range.extractContents();
    const span = document.createElement('span');
    span.dataset.ansi = ansiCode;
    if (mode === 'color') span.style.color = cssValue;
    if (mode === 'bg') span.style.backgroundColor = cssValue;
    if (mode === 'style') {
      // стили: ansiCode содержит '[x;30m'
      // чтобы визуализировать, применяем через CSS
      const codeNum = ansiCode.match(/\[(\d+);/)[1];
      if (codeNum === '1') span.style.fontWeight = 'bold';
      if (codeNum === '2') span.style.fontStyle = 'italic';
      if (codeNum === '4') span.style.textDecoration = 'underline';
    }
    span.appendChild(frag);
    range.insertNode(span);
    sel.removeAllRanges();
  }

  // Стили
  const styleMap = { bold: '1;30', italic: '2;30', underline: '4;30' };
  Object.keys(styleMap).forEach(id => {
    document.getElementById(id).addEventListener('click', () => {
      const code = ESC + '[' + styleMap[id] + 'm';
      wrapSelection(null, code, 'style');
    });
  });

  // Очистка форматирования
  document.getElementById('clear-format').addEventListener('click', () => {
    const sel = window.getSelection(); if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const frag = range.cloneContents();
    const text = frag.textContent;
    range.deleteContents();
    range.insertNode(document.createTextNode(text));
    sel.removeAllRanges();
  });

  // Генерация текста
  function generate(root) {
    let out = '';
    let inside = false;
    const open = () => { if (!inside) { out += '```ansi\n'; inside = true; } };
    const close = () => { if (inside) { out += '\n```'; inside = false; } };

    function walk(node) {
      if (node.nodeType === Node.TEXT_NODE) {
        out += node.textContent;
        if (/\S/.test(node.textContent) && !node.parentElement.dataset.ansi) close();
        return;
      }
      if (node.nodeType !== Node.ELEMENT_NODE) return;
      if (node.tagName === 'BR') { out += '\n'; return; }
      if (node.dataset.ansi) {
        open(); out += node.dataset.ansi;
        node.childNodes.forEach(walk);
        out += ESC + '[0m';
      } else node.childNodes.forEach(walk);
    }

    root.childNodes.forEach(walk);
    close();
    return out.trim();
  }

  // Копировать
  document.getElementById('copy').addEventListener('click', () => {
    const text = generate(document.getElementById('editor'));
    navigator.clipboard.writeText(text).then(() => {
      const t = document.getElementById('toast');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1200);
    });
  });
</script>
</body>
</html>
